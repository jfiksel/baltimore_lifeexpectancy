---
title: "Baltimore Life Expectancy"
author: "Jacob Fiksel"
date: "September 12, 2016"
output: html_document
---
The purpose of this project is to predict life expectancy in Baltimore on a single block resolution. The main source of data for life expectancy at the neighborhood level are the [Baltimore City Health Department Neighborhood Health Profiles](http://health.baltimorecity.gov/node/231). I plan on utilizing free data provided by [OpenBaltimore](https://data.baltimorecity.gov), which appears to have a more cleaned up version of the above data set in the [Children and Family Health & Well-Being (2010-2014)](https://data.baltimorecity.gov/Neighborhoods/Children-and-Family-Health-Well-Being-2010-2014-/rtbq-mnni) and [Housing and Community Development (2010-2014)](https://data.baltimorecity.gov/Neighborhoods/Housing-and-Community-Development-2010-2014-/mvvs-32jm) reports. The codebook is [here](https://data.baltimorecity.gov/Neighborhoods/BNIA-Vital-Signs-Codebook/ryvy-9zw6). 

### Main question
Can we predict life expectancy at the block-level resolution in Baltimore using various health, crime, and economic statistics collected at the individual house level and/or aggregated to the block or neighborhood level?

### Datasets that I have downloaded 

* [Children and Family Health & Well-Being (2010-2014)](https://data.baltimorecity.gov/Neighborhoods/Children-and-Family-Health-Well-Being-2010-2014-/rtbq-mnni)
* [Housing and Community Development (2010-2014)](https://data.baltimorecity.gov/Neighborhoods/Housing-and-Community-Development-2010-2014-/mvvs-32jm)
* [Building vacancies in Baltimore](https://data.baltimorecity.gov/Housing-Development/Vacant-Buildings/qqcv-ihn5) which provides the street and neighborhood of all current building vacancies. This is updated at least twice a month
* [Victim based crime](https://data.baltimorecity.gov/Public-Safety/BPD-Part-1-Victim-Based-Crime-Data/wsfq-mvij). Accessing this on Sept. 13, 2016 the most recent crime listed occurred on Sept. 3, 2016
* [Real property taxes](https://data.baltimorecity.gov/Financial/Real-Property-Taxes/27w9-urtv) at an address level
* [Liquor licenses](https://data.baltimorecity.gov/City-Services/Liquor-Licenses/xv8d-bwgi)
* [2010 Census data](https://data.baltimorecity.gov/Neighborhoods/Census-Demographics-2010/cix3-h4cy) at a neighborhood level
* [Grocery stores](https://data.baltimorecity.gov/Health/Grocery-Stores/uuwk-975y). Contains type of supermarket and location. Could be interesting to look at distance to closest grocery store, and clusters of small or limited groceries stores predict health outcomes
* [BPD Arrests](https://data.baltimorecity.gov/Public-Safety/BPD-Arrests/n29z-hvc9). Includes address of arrest for some, but not all arrests
* [Baltimore prositution](https://data.baltimorecity.gov/Public-Safety/Prostitution-in-Baltimore-City/hky9-jqjm)
* [Block-level state shape file](https://www.nhgis.org)
* [Restaurants in Baltimore](https://data.baltimorecity.gov/Culture-Arts/Restaurants/k5ry-ef3g)
* [ACS Block Group Household Income Data]

### Preprocessing
* Have used codebook available online to rename variables so they are more easily understandable
* Have cleaned up latitude and longitude where it applies 
* Lots of missing locations, especially on arrest data
    + Have to investigate if this is random throughout police districts, or is biased
* Use Google Maps API to get latitude and longitude for any data sets without this. Then use this to infer neighborhood & block for any datasets where neighborhood is not listed
    + Use R package rgdl to map property taxes by latitude and longitude to csa
* Clean up dates
* "Tidy" data. Separate data sets with numeric and character variables. Use either neighborhood or block as key

### Visualizations


```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(sp)
library(leaflet)
library(maptools)
library(ggplot2)
library(plyr)
library(ggmap)
library(acs)
library(tigris)
csa <- readRDS(list.files(path=file.path("data", "raw_data"),
                          pattern="csa_shapes.rds", full.names=TRUE))
blocks <- readRDS(list.files(path=file.path("data", "raw_data"),
                             pattern="census_blocks.rds", full.names=TRUE))

well_being <- readRDS(list.files(file.path("data", "processed_data"),
                      pattern="well_being2014.rds", full.names=TRUE))
property_taxes <- readRDS(list.files(file.path("data", "processed_data"),
                                     pattern="property_taxes.rds", full.names=TRUE))
victim_crime2015 <- readRDS(list.files(file.path("data", "processed_data"),
                                       pattern="victim_crime2015.rds", full.names=TRUE))

key <- na.omit(match(csa@data$Community, well_being$csa))
### Remove jail
csa <- csa[-51,]

### CSA coordinates to latitude and longitude
llprj <-  "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs +towgs84=0,0,0"
csa <- spTransform(csa,  llprj)


### Plot CSA life expectancy 
csa@data$id <- csa@data$Community
csa@data$life_expectancy <- well_being$life_exepctancy[key]
csa.points <- fortify(csa, region="id")
csa.df <- join(csa.points, csa@data, by="id")
csa.df$life_expectancy <- as.numeric(csa.df$life_expectancy)

myggmap <- get_map(location="Baltimore", zoom=12)

ggmap(myggmap)+
  geom_path(data=csa.df, aes(x=long, y=lat, group=group), color="black")  +
  geom_polygon(data=csa.df, aes(x=long, y=lat, group=group, fill=life_expectancy), alpha=.4) +
  geom_point(data=victim_crime2015[victim_crime2015$description=="SHOOTING",], aes(x=longitude, y=latitude), alpha=.5) +
  scale_fill_gradientn("Life expectancy", colors=c('red', 'yellow', 'green')) +
  xlab("Longitude") + ylab("Latitude") + 
  ggtitle("Baltimore Life Expectancy and Shootings 2015")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggmap(myggmap)+
  geom_point(data=property_taxes[property_taxes$citytax <=20000,],
             aes(x=longitude, y=latitude,colour=citytax), alpha=.5) +
  geom_path(data=csa.df, aes(x=long, y=lat, group=group), color="black") +
  scale_colour_gradientn("City taxes", colors=c('red', 'yellow', 'lightgreen', 'darkgreen')) +
  xlab("Longitude") + ylab("Latitude") + 
  ggtitle("Baltimore Property Taxes")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
## Baltimore City= 510
acs_api <- "9de0607b39f202d656f833c9ed107b4d7e62ac0d"
api.key.install(acs_api)
income_data <- acs.fetch(endyear=2014,
                         geography=geo.make(state="MD",
                                            county=510,
                                            tract="*",
                                            block.group="*"),
                         variable="B19013_001")


income_df <- data.frame(GEOD=paste0(as.character(income_data@geography$state), 
                                    as.character(income_data@geography$county),
                                    income_data@geography$tract,
                                    income_data@geography$blockgroup), 
                        hhincome=income_data@estimate)
colnames(income_df) <- c("GEOID", "hhincome")
income_df <- income_df[!is.na(income_df$hhincome),]

blocks.groups <- block_groups(state="MD", county=510)
k <- which(substr(blocks.groups@data$TRACTCE, 1, 1)=="0")
blocks.groups@data[k,]$GEOID <- paste0(substr(blocks.groups@data[k,]$GEOID, 1, 4), substr(blocks.groups@data[k,]$GEOID, 6, 12))
blocks.groups@data$GEOID <- factor(blocks.groups@data$GEOID)
bmore_merged <- geo_join(blocks.groups, income_df, "GEOID", "GEOID")

bmore_merged@data$id <- bmore_merged@data$GEOID
bmore_merged.points <- fortify(bmore_merged, region="id")
bmore_merged.df <- join(bmore_merged.points, bmore_merged@data, by="id")

ggmap(myggmap)+
  geom_path(data=bmore_merged.df, aes(x=long, y=lat, group=group), color="black") +
  geom_polygon(data=bmore_merged.df, aes(x=long, y=lat, group=group, fill=hhincome), alpha=0.5)+
  scale_fill_gradientn("Average Household Income", colors=c('red', 'yellow', 'lightgreen', 'darkgreen')) +
  xlab("Longitude") + ylab("Latitude") + 
  ggtitle("Baltimore Block Group Household Income 2014")
```

### Analysis plan

* Continue to identify any data sets/variables that need cleaning
* Read downsampling literature
* Decide whether to take a "machine learning approach" or more informed statistical approach
    + By "informed" statistical approach, that means I do some variable selection on my own and use more traditional technique like LM/GLM
* To identify variables of interest, there are two things to pay attention to:
    + How homogeneous they are within neighborhood AND potentially correlated with life expectancy
    + They can be aggregated at CSA scale and can be predicted from house/block level data
* Decide how to use neighborhood spatial correlation
* Apply method to predict at CENSUS block level


### Packages
* maps
* maptools
* rgdal
* rgeos
* ggmap
* tigris



